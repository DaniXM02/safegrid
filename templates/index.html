<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Grupo 06 — SafeGrid (Proyecto Tráfico)</title>
  <script src="/static/chart.umd.min.js"></script>
  <style>
    :root{--bg:#07101f;--card:#0b1a33;--stroke:#15345f;--txt:#dbe7ff;--mut:#92a7c7;--ok:#30d158;--bad:#ff453a}
    body{margin:0;background:linear-gradient(180deg,#050b16,#07101f);color:var(--txt);font:14px system-ui}
    header{padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
    .h1{font-weight:700;font-size:18px}
    .sub{color:var(--mut);font-size:12px;margin-top:2px}
    .pill{display:inline-flex;gap:8px;align-items:center;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:6px 10px}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--bad)}
    .dot.ok{background:var(--ok)}
    .wrap{display:grid;grid-template-columns:1.2fr 1fr;gap:14px;padding:0 14px 14px}
    .card{background:radial-gradient(1200px 400px at 10% 0%,rgba(77,130,255,.12),transparent),var(--card);
      border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .k{color:var(--mut);font-size:12px}
    .v{font-size:20px;font-weight:700}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .btn{cursor:pointer;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06);color:var(--txt);padding:8px 10px}
    .btn:hover{background:rgba(255,255,255,.10)}
    canvas{width:100%!important;height:260px!important}
    .list{display:flex;flex-direction:column;gap:8px}
    .toma{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.18)}
    .toma .name{font-weight:700}
    .badge{font-size:12px;border-radius:999px;padding:5px 10px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06)}
    .badge.ok{color:#0a2; border-color:rgba(48,209,88,.35); background:rgba(48,209,88,.10)}
    .badge.off{color:#f66}
    .chatbox{height:190px;overflow:auto;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px;background:rgba(0,0,0,.18)}
    input{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:var(--txt)}
    .hint{color:var(--mut);font-size:12px;margin-top:6px}
    a{color:#9bc1ff}
  </style>
</head>
<body>
<header>
  <div>
    <div class="h1">Grupo 06 — SafeGrid (Proyecto Tráfico)</div>
    <div class="sub">Dashboard local + Chat (DB + AI). Última actualización: <span id="lastAt">—</span></div>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <div class="pill"><span class="dot" id="dotDB"></span> DB</div>
    <div class="pill"><span class="dot" id="dotMQTT"></span> MQTT</div>
    <div class="pill"><span class="dot" id="dotAI"></span> AI</div>
    <button class="btn" id="btnRefresh">Actualizar</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="row"><div style="font-weight:700">Red y QoS</div><div class="k">SSID: <span id="ssid">—</span> · QoS src: <span id="qosSrc">—</span></div></div>
    <div class="grid3" style="margin-top:10px">
      <div class="card" style="padding:10px">
        <div class="k">Uso total</div>
        <div class="v"><span id="mbpsTotal">—</span> <span class="k">Mbps</span></div>
        <div class="k">Utilización: <span id="utilPct">—</span> · Estado: <span id="netState">—</span></div>
      </div>
      <div class="card" style="padding:10px">
        <div class="k">QoS (interpretación)</div>
        <div class="v" id="qosLabel">—</div>
        <div class="k" id="qosAdvice">—</div>
      </div>
      <div class="card" style="padding:10px">
        <div class="k">Alertas</div>
        <div class="v" id="alertsCount">—</div>
        <div class="k">Ventana: 120s</div>
      </div>
    </div>

    <!-- ✅ Ngrok con botón manual -->
    <div class="card" style="margin-top:10px">
      <div class="row">
        <div>
          <div class="k">Ngrok</div>
          <div style="margin-top:6px"><a id="ngrokLink" href="#" target="_blank">—</a></div>
        </div>
        <button class="btn" id="btnNgrok">Actualizar Ngrok</button>
      </div>
      <div class="hint">Ngrok no se refresca automáticamente (solo con el botón).</div>
    </div>

    <div class="card" style="margin-top:10px">
      <div style="font-weight:700;margin-bottom:8px">Congestión de red (utilización %) en vivo</div>
      <canvas id="chartUtil"></canvas>
    </div>

    <div class="card" style="margin-top:10px">
      <div style="font-weight:700;margin-bottom:8px">hi/med/low vs capacidad (Mbps)</div>
      <canvas id="chartHML"></canvas>
    </div>

    <div class="card" style="margin-top:10px">
      <div style="font-weight:700;margin-bottom:8px">Alertas por tiempo (últimos 120s)</div>
      <canvas id="chartAlerts"></canvas>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:700">Servicios y Tomas</div>
      <div class="k">TTL: <span id="ttl">—</span>s</div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="k">Raspberry (último sample)</div>
      <div style="margin-top:6px" id="piLine">—</div>
    </div>

    <div class="card" style="margin-top:10px">
      <div style="font-weight:700;margin-bottom:8px">Amperaje por toma (últimos puntos)</div>
      <canvas id="chartTomas"></canvas>
    </div>

    <div class="list" style="margin-top:10px" id="tomasList"></div>

    <div class="card" style="margin-top:10px">
      <div style="font-weight:700;margin-bottom:8px">Chat (DB + AI)</div>
      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
        <button class="btn quick">estado</button>
        <button class="btn quick">red</button>
        <button class="btn quick">tomas</button>
        <button class="btn quick">toma1</button>
      </div>
      <div class="chatbox" id="chatLog"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="chatIn" placeholder="Escribe: estado / red / tomas / toma1"/>
        <button class="btn" id="chatSend">Enviar</button>
      </div>
      <div class="hint">Nota: intento SSE (/api/stream) y si falla uso polling (/api/state).</div>
    </div>
  </div>
</div>

<script>
let chartUtil, chartHML, chartTomas, chartAlerts;
let es = null;
let polling = null;

let lastRxMs = 0;
function markRx(){ lastRxMs = Date.now(); }

const EXPECTED_TOMAS = ["toma1","toma2","toma3"];

function setDot(id, ok){
  const d = document.getElementById(id);
  d.classList.toggle("ok", !!ok);
}

function initCharts(){
  const common = {responsive:true, maintainAspectRatio:false, animation:false};

  chartUtil = new Chart(document.getElementById("chartUtil"), {
    type:"line",
    data:{labels:[], datasets:[{label:"Utilización %", data:[], tension:.25}]},
    options:{...common, scales:{y:{beginAtZero:true}}}
  });

  chartHML = new Chart(document.getElementById("chartHML"), {
    type:"bar",
    data:{labels:["hi","med","low","cap"], datasets:[{label:"Mbps", data:[0,0,0,0]}]},
    options:{...common, scales:{y:{beginAtZero:true}}}
  });

  chartTomas = new Chart(document.getElementById("chartTomas"), {
    type:"line",
    data:{labels:[], datasets:[]},
    options:{...common, scales:{y:{beginAtZero:true}}}
  });

  chartAlerts = new Chart(document.getElementById("chartAlerts"), {
    type:"bar",
    data:{labels:[], datasets:[{label:"Alertas/seg", data:[]}]},
    options:{...common, scales:{y:{beginAtZero:true}}}
  });
}

function fmt(n, d=2){ return (n==null || isNaN(n)) ? "—" : Number(n).toFixed(d); }

function updateUI(st){
  document.getElementById("lastAt").textContent = st.generated_at_local || "—";
  document.getElementById("ssid").textContent = st.ssid || "—";
  document.getElementById("ttl").textContent = st.ttl_sec ?? "—";

  setDot("dotDB", st.services?.db);
  setDot("dotMQTT", st.services?.mqtt);
  setDot("dotAI", st.services?.ai);

  // Net cards
  document.getElementById("qosSrc").textContent = st.net?.qos_src || "—";
  document.getElementById("mbpsTotal").textContent = fmt(st.net?.total_mbps,2);
  document.getElementById("utilPct").textContent = fmt(st.net?.util_pct,2) + "%";
  document.getElementById("netState").textContent = st.net?.state || "—";
  document.getElementById("qosLabel").textContent = st.net?.qos_panel?.qos || "—";
  document.getElementById("qosAdvice").textContent = st.net?.qos_panel?.advice || "—";

  // Alerts card
  document.getElementById("alertsCount").textContent = st.alerts?.count_120s ?? 0;

  // Pi line
  const pi = st.pi || {};
  const piTs = pi.ts ? `ts ${pi.ts}` : "sin datos";
  const cpu = (pi.cpu_pct!=null) ? `CPU ${fmt(pi.cpu_pct,1)}%` : "CPU —";
  const ram = (pi.ram_used_gb!=null && pi.ram_total_gb!=null) ? `RAM ${fmt(pi.ram_used_gb,2)}/${fmt(pi.ram_total_gb,2)} GB` : "RAM —";
  const tmp = (pi.temp_c!=null) ? `Temp ${fmt(pi.temp_c,1)}°C` : "Temp —";
  document.getElementById("piLine").textContent = `${piTs} · ${cpu} · ${ram} · ${tmp}`;

  // Tomas list
  const tomas = st.tomas_detail || [];
  const map = {};
  tomas.forEach(t=>{ if(t?.toma) map[t.toma]=t; });

  const list = document.getElementById("tomasList");
  list.innerHTML = "";
  EXPECTED_TOMAS.forEach(tn=>{
    const t = map[tn] || {toma:tn, online:false, age_sec:null, amperaje:null, potencia_w:null, estado:null, rssi:null};
    const row = document.createElement("div");
    row.className="toma";
    row.innerHTML = `
      <div>
        <div class="name">${t.toma}</div>
        <div class="k">I: ${fmt(t.amperaje,2)} A · P: ${fmt(t.potencia_w,1)} W · ${t.estado||"—"} · RSSI ${t.rssi??"—"}</div>
      </div>
      <div class="badge ${t.online?'ok':'off'}">${t.online?'ONLINE':'OFF'}</div>
    `;
    list.appendChild(row);
  });
}

function updateCharts(st){
  const netSeries = st.series?.net || [];
  chartUtil.data.labels = netSeries.map(x => new Date((x.ts||0)*1000).toLocaleTimeString());
  chartUtil.data.datasets[0].data = netSeries.map(x => {
    const hi=Number(x.hi_mbps||0), med=Number(x.med_mbps||0), low=Number(x.low_mbps||0), cap=Number(x.cap_mbps||0);
    const total = hi+med+low;
    return cap ? (total/cap*100) : 0;
  });
  chartUtil.update();

  if(netSeries.length){
    const x = netSeries[netSeries.length-1];
    chartHML.data.datasets[0].data = [Number(x.hi_mbps||0), Number(x.med_mbps||0), Number(x.low_mbps||0), Number(x.cap_mbps||0)];
    chartHML.update();
  }

  // Alerts series
  const as = st.alerts?.series || [];
  chartAlerts.data.labels = as.map(x => new Date((x.ts||0)*1000).toLocaleTimeString());
  chartAlerts.data.datasets[0].data = as.map(x => Number(x.n||0));
  chartAlerts.update();

  // Tomas series
  const tomas = st.series?.tomas || {};
  const tomaNames = Array.from(new Set([...EXPECTED_TOMAS, ...Object.keys(tomas)]))
    .filter(n => n.toLowerCase().startsWith("toma"))
    .sort();

  let labels = [];
  for(const tn of tomaNames){
    const s = tomas[tn] || [];
    if(s.length){ labels = s.map(p => new Date((p.ts||0)*1000).toLocaleTimeString()); break; }
  }

  chartTomas.data.labels = labels;
  chartTomas.data.datasets = tomaNames.map((tn) => {
    const s = tomas[tn] || [];
    return { label: tn, data: s.map(p => Number(p.amperaje||0)), tension:.25 };
  });
  chartTomas.update();
}

async function fetchStateOnce(){
  const r = await fetch("/api/state", {cache:"no-store"});
  const st = await r.json();
  markRx();
  updateUI(st);
  updateCharts(st);
}

function startPolling(){
  if(polling) return;
  polling = setInterval(()=>fetchStateOnce().catch(()=>{}), 1000);
}

function stopPolling(){
  if(polling){ clearInterval(polling); polling=null; }
}

function startSSE(){
  try{
    if(es) es.close();
    es = new EventSource("/api/stream");
    es.onmessage = (ev)=>{
      try{
        const st = JSON.parse(ev.data);
        markRx();
        updateUI(st);
        updateCharts(st);
      }catch(e){}
    };
    es.onerror = ()=>{
      try{ es.close(); }catch(e){}
      es = null;
      startPolling(); // ✅ solo si SSE falla
    };
  }catch(e){
    startPolling();
  }
}

function watchdog(){
  setInterval(()=>{
    if(Date.now() - lastRxMs > 5000){
      // si se congeló, fuerza polling y reintenta SSE
      stopPolling();
      startPolling();
      try{ if(es){ es.close(); } }catch(e){}
      es = null;
      setTimeout(()=>startSSE(), 1500);
      markRx();
    }
  }, 2000);
}

async function chatSend(text){
  const log = document.getElementById("chatLog");
  log.innerHTML += `<div class="k">> ${text}</div>`;
  log.scrollTop = log.scrollHeight;
  const r = await fetch("/api/chat", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({text})});
  const j = await r.json();
  log.innerHTML += `<div style="margin-top:6px">${(j.reply||"—").replaceAll("\n","<br>")}</div><div style="height:10px"></div>`;
  log.scrollTop = log.scrollHeight;
}

async function refreshNgrok(){
  const a = document.getElementById("ngrokLink");
  a.textContent = "cargando…";
  a.href = "#";
  try{
    const r = await fetch("/api/ngrok", {cache:"no-store"});
    const j = await r.json();
    const url = (j.url||"").trim();
    if(url){
      a.textContent = url;
      a.href = url;
    }else{
      a.textContent = "—";
      a.href = "#";
    }
  }catch(e){
    a.textContent = "—";
    a.href = "#";
  }
}

document.getElementById("btnRefresh").onclick = ()=>fetchStateOnce().catch(()=>{});
document.getElementById("btnNgrok").onclick = ()=>refreshNgrok().catch(()=>{});

document.getElementById("chatSend").onclick = ()=>{
  const i = document.getElementById("chatIn");
  const t = i.value.trim(); if(!t) return;
  i.value="";
  chatSend(t).catch(()=>{});
};

document.querySelectorAll(".quick").forEach(b=>{
  b.onclick = ()=>{ document.getElementById("chatIn").value = b.textContent.trim(); };
});

initCharts();
markRx();
fetchStateOnce().catch(()=>{});
refreshNgrok().catch(()=>{}); // ✅ una vez al cargar (si quieres, puedes borrarlo)
startSSE();      // ✅ intenta SSE
// startPolling();  // ❌ ya no: solo fallback si SSE falla
watchdog();
</script>
</body>
</html>
